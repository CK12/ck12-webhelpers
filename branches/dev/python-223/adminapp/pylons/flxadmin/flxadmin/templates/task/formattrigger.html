{% extends "master.html" %}  

{% block admincontent %}  
<div class="sectionhead sectiontitle">Print Formats</div>
<div class="section">
  <div class='margined'>
    <div>Generated Formats for {{c.artifact_link}}:</div>
    <div id='formatsStr'>{{c.formats_str}}</div>
    <br/>
    <input type="submit" id='epub' class="btn primaryaction med"
      value=" {% if c.urls.epub %}Re-{% endif %}Generate ePub" />
    <input type="submit" id='mobi' class="btn primaryaction med"
      value=" {% if c.urls.mobi %}Re-{% endif %}Generate Mobi" />
    <input type="submit" id='pdf' class="btn primaryaction med" 
      value=" {% if c.urls.pdf %}Re-{% endif %}Generate PDF" />
  </div>
</div>

<span class='ajaxError'></span>
<div class="prethead">Recent Print Tasks for this Artifact</div>
<div id='nonefound'></div>
<div class="thead sectionhead hide">
  <div class="tr">
    <div class="td">Id</div>
    <div class="td">Name</div>
    <div class="td">Status</div>
    <div class="td">Started</div>
    <div class="td">Updated</div>
    <div class="td">Result</div>
    <div class="td">User Data</div>
  </div>
</div>
<div class="tbody" id='results'></div>
{% endblock admincontent %}

{% block js_scripts %}
<script type="text/javascript">
$(document).ready(function(){
  var 
  pageSize = 150, // pageSize for tasks API (need many since need to filter right one)
  maxStats = 5,   // max stats to show 
  updateInterval = Defaults.interval.med, 
  taskUrlRoot = CK12.flxUrl('get/status/task/'),
  tasksUrl = CK12.flxUrl('get/info/tasks?filters=name,pdf%3Bname,epub%3Bname,mobi&pageSize='+pageSize+'&sort=updated,desc'),
  artifactId = '{{c.artifactID}}',
  _artifactID_revisionID = '/{{c.artifactID}}/{{c.revisionID}}',
  formatsInfoUrl = CK12.admUrl('/formatsinfo'+_artifactID_revisionID),
  $thead = $('.thead'),
  $results = $('#results'),
  $submit = $('input[type=submit]'),
  $statuses = $('#statuses'),
  $formatsStr = $('#formatsStr'),
  $nonefound = $('#nonefound'),
  tasks = [],

  formatTask = function(task){ 
    var 
      justNowMsg = 'just now',
      _id = task.id || '',
      _link = (_id && task.name)? CK12.admHtmla('/task/'+_id, task.name) :
                                  CK12.admHtmla('/task/'+task.task_id, 'task'),
      _status = task.status || 'PENDING',
      _started = task.started || justNowMsg, 
      _updated = task.updated || justNowMsg, 
      _result  = task.result || '',
      _userdata = task.userdata || '';
    return '<div class="tr">\
      <div class="td id">'+_id+'</div>\
      <div class="td">'+_link+'</div>\
      <div class="td status">'+_status+'</div>\
      <div class="td">'+_started+'</div>\
      <div class="td">'+_updated+'</div>\
      <div class="td">'+_result+'</div>\
      <div class="td">'+_userdata+'</div>\
      <div class="td taskID hide">'+task.task_id+'</div>\
    </div>';
  },
  updateFormatsInfo = function(){
    $.get(formatsInfoUrl, function(data){
      $formatsStr.html(data.str);
      $(data.list).each(function(i, name){
        var $btn = $submit.filter('#'+name);
        $btn.val($btn.val().replace(' Generate', 'Re-Generate'));
      })
    });
  },
  toggleBtnsState = function($btn, disable){
    // disables button if disable evals to true or not defined,
    // disables epub button also if btn id is mobi
    var 
      isMobi = $btn.attr('id') == 'mobi',
      disable = typeof disable==='undefined'? true : disable;
    $btn.toggleClass('disabled', disable);
    if (isMobi){
      $submit.filter('#epub').toggleClass('disabled', disable);
    }
  },
  artifactInTask = function(task){ 
    // Returns true if artifactId found in task result
    var idMatched = task.result? task.result.match(/artifactID:+\s*(\d+),/) || /*required to match epub response*/ task.result.match(/'artifactID':\s(\d+)*/):null;
    if (idMatched && idMatched.length == 2 && idMatched[1] == artifactId)
      return true;
    return false;
  },
  updateTasks = function(data){
    // update tasks list
    if (tasks.length >= maxStats) return;
    var _tasks = data.response? data.response.tasks : [];
    $(_tasks).each(function(i, task){
      if (artifactInTask(task))
        tasks.push(task);
    });
  };

  // submit action handler
  $submit.click(function(){
    var 
      $this = $(this),
      ok = $this.hasClass('disabled')? confirm(
        "Formatting seems to be already in progress.  Are you sure you want to trigger a new one?")
        : true,
      url = CK12.flxUrl('render/'+$this.attr('id')+_artifactID_revisionID+'/nocache');
    if (ok){
      $.ajax({url: url,
        success: function(data) {
          $thead.removeClass('hide');
          $nonefound.addClass('hide');
          $results.prepend(formatTask(data.response||{}));
          toggleBtnsState($this, true);
          Fns.colorStatus();
        }
      });
    }
  });

  // update recent print format tasks on page load 
  $.ajax({url: tasksUrl,
    success: function(data) {
      updateTasks(data);

      // populate table with tasks or show "None found", disable submit if inProgress
      var result_html = '';
      $(tasks).each(function(i, task){
        var $btn = $submit.filter('#'+task.name);
        result_html += formatTask(task);
        toggleBtnsState($btn, Fns.inProgress(task.status));
      });
      if (result_html){
        $thead.removeClass('hide');
        $results.html(result_html);
        Fns.colorStatus();
      }else{
        $nonefound.text('(None found in recent '+pageSize+' pdf/epub/mobi tasks)');
      }
    }
  });

  // poll status
  Fns.pollStatus = function(){
    $('.status').each(function (i, elm){
      var 
        $elm = $(elm),
        status = $elm.text().trim();
      if (Fns.inProgress(status)){
        var 
          isNewTask = $elm.siblings('.id').text() == '',
          id = isNewTask? $elm.siblings('.taskID').text() : 
                          $elm.siblings('.id').text(),
          taskUrl = taskUrlRoot+id;
        if (id){
          $.ajax({url: taskUrlRoot+id,
            success: function(data) {
              var 
                task = data.response,
                $btn = $submit.filter('#'+task.name),
                $row = $elm.parent();
              toggleBtnsState($btn, Fns.inProgress(task.status));
              $row.replaceWith(formatTask(task));
              Fns.colorStatus();
              if (task.status == 'SUCCESS'){
                updateFormatsInfo();
              }
            }
          });
        }
      }
    });
  };
  Poll = setInterval("Fns.pollStatus()", updateInterval); 
});
</script>
{% endblock %}
