!function(){"use strict";tinymce.PluginManager.requireLangPack("ck12embed");var a,b,c="",d="id|name|title|longdesc|class|width|height|src|frameborder",e="itemprop|itemscope|itemtype",f="description|image|name|url",g="ck12-media-placeholder",h="/images/trans.gif",i="x-ck12-element-box";tinymce.create("tinymce.plugins.CK12EmbedPlugin",{init:function(a,d){var e=this;b=e,this.editor=a,a.settings.ck12_plugins_url&&(d=a.settings.ck12_plugins_url+"ck12embed"),c=e.plugin_url=d,a.on("preinit",function(){var b=null,c=null;a.parser.addNodeFilter("iframe",function(a){for(var d=a.length;d--;)c=a[d],b=e.embedNodeToImg(c),e.replaceNode(c.parent,b)}),a.serializer.addNodeFilter("img",function(a,b,c){for(var d,f=a.length;f--;){d=a[f];var g=d.attr("class")||"";-1!==g.indexOf("ck12-media-placeholder")&&e.imgToEmbed(d,c)}})}),a.addCommand("mceEmbedDialog",function(){b.setSelection(a),a.windowManager.open({title:"Embed Object",file:c+"/embed.htm",width:420,height:500,inline:1},{plugin_url:c}),a.fire("focus:window")}),a.addCommand("mceEmbedDelete",function(){var c;b.setSelection(a),c=a.selection.getNode(),c&&c.className&&-1!==c.className.indexOf(g)&&c.parentNode.removeChild(c)}),a.addButton("ck12embed",{title:"Insert/Edit Media",icon:"media",cmd:"mceEmbedDialog","class":"mce_media"}),a.on("nodechange",function(b){var c=b.element,d=!1;if(a&&a.parents&&a.parents.length>0)for(var e=0;e<a.parents.length&&!d;e++){var f=a.parents[e];"TD"===f.tagName.toUpperCase()?d=!0:"DIV"===f.tagName.toUpperCase()&&-1!==f.className.indexOf(i)&&(d=!0)}d||"TD"!==c.nodeName&&("DIV"!==c.nodeName||-1===c.className.indexOf(i))||(d=!0),null!==c.parentNode&&"P"!==c.parentNode.nodeName&&(("P"!==c.nodeName||"BODY"!==c.parentNode.nodeName)&&(d=!0),tinymce.isIE&&"BODY"===c.nodeName&&"HTML"===c.parentNode.nodeName&&(d=!1)),d?(a.fire("inactive",{button:"ck12embed"}),a.fire("disable",{button:"ck12embed"})):"IMG"===c.nodeName&&c.className?-1===c.className.indexOf(g)?(a.fire("inactive",{button:"ck12embed"}),a.fire("disable",{button:"ck12embed"})):(a.fire("active",{button:"ck12embed"}),a.fire("enable",{button:"ck12embed"}),a.fire("inactive",{button:"image"})):(a.fire("inactive",{button:"ck12embed"}),a.fire("enable",{button:"ck12embed"}))}),a.on("init",function(){a&&(a.plugins.contextmenu||a.plugins.ck12contextmenu)&&(a.addMenuItem("embedObjectEditCM",{text:"Edit Embedded Object",context:"insert",cmd:"mceEmbedDialog",icon:"media",onPostRender:function(){e.contextMenu.postRender.call(this,a)},ui:!0}),a.addMenuItem("embedObjectDeleteCM",{text:"Delete Embedded Object",context:"insert",cmd:"mceEmbedDelete",icon:"ck12EmbedDelete",onPostRender:function(){e.contextMenu.postRender.call(this,a)},ui:!0}))})},contextMenu:{postRender:function(c){function d(){b.setSelection(c);var a=c.dom,d=c.selection.getNode(),e=d&&"IMG"===d.nodeName&&a.getAttrib(d,"class").indexOf(g)>-1;f.disabled(!e),f.visible(e),e&&c.fire("contextmenu:override",{enable:["ck12embed"]})}function e(){c.on("contextmenu:reselect",function(b){a=b.range||null}),c.on("contextmenu:postrender",d)}var f=this;c.initialized?e():c.on("init",e)}},createControl:function(a,b){return null},_in_array:function(a,b){var c,d;for(c=0;c<a.length;c++)if(d=a[c],d==b)return!0;return!1},embedNodeToJSON:function(a){var b=this;if(a){var c,g,h=e.split("|"),i=d.split("|"),j=f.split("|"),k={};for(c=a.attributes.length;c--;)g=a.attributes[c],b._in_array(i,g.name)&&(k["data-ck12embed-iframe-"+g.name]=g.value);var l=a.parent;if(l){if("div"===l.name)for(c=l.attributes.length;c--;)g=l.attributes[c],b._in_array(h,g.name)&&(k["data-ck12embed-container-"+g.name]=g.value);var m=l.getAll("meta");if(m&&m.length)for(c=m.length;c--;){g=m[c];var n=g.attr("itemprop"),o=g.attr("content");b._in_array(j,n)&&(k["data-ck12embed-meta-"+n]=o)}}return k}},embedNodeToImg:function(a){var b=this;if(a){var d=b.embedNodeToJSON(a),e=tinymce.html.Node.create("img",d);return e.attr("src",c+h),e.attr("class",g),d["data-ck12embed-iframe-width"]&&e.attr("width",d["data-ck12embed-iframe-width"]),d["data-ck12embed-iframe-height"]&&e.attr("height",d["data-ck12embed-iframe-height"]),e}},htmlstrToImg:function(a){var b=null,c=null;return a&&(b=this.editor.parser.parse(a),b&&(c=b.getAll("img")[0])),c},imgToEmbed:function(a,b){if(a){var c,d,e,f={container:{},iframe:{},meta:{}};for(d=a.attributes.length;d--;)c=a.attributes[d],e=c.name.replace("data-ck12embed-","").split("-"),f[e[0]]&&(f[e[0]][e[1]]=c.value);var g=tinymce.html.Node.create("div",f.container);if(g.attr("itemscope")||g.attr("itemscope",""),f.meta){var h=null;for(e in f.meta)f.meta.hasOwnProperty(e)&&(c=f.meta[e],h=this.editor.parser.parse("<meta />").getAll("meta")[0],h.attr("itemprop",e),h.attr("content",c),g.append(h))}!f.iframe||"frameborder"in f.iframe||(f.iframe.frameborder="0");var i=tinymce.html.Node.create("iframe",f.iframe);g.append(i),a.replace(g)}},replaceNode:function(a,b){try{a.replace(b)}catch(c){console.error(c)}},setSelection:function(b){var c=b.selection.getRng();a&&c!==a?(b.selection.setRng(a),a=null):c===a&&(a=null)},getInfo:function(){return{longname:"CK-12 Embedded Objects",author:"Nachiket Karve",authorurl:"http://www.ck12.org",infourl:"https://insight.ck12.org/wiki/index.php/Tinymce-flxweb",version:"1.0"}}}),tinymce.PluginManager.add("ck12embed",tinymce.plugins.CK12EmbedPlugin)}();