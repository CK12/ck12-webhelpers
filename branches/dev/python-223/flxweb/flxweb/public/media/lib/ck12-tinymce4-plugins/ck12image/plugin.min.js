!function(){"use strict";function e(e){var n=e.selection.getRng();t&&n!==t?(e.selection.setRng(t),t=null):n===t&&(t=null)}var t,n,i,a,o=tinymce.dom.Event;tinymce.create("tinymce.plugins.CK12ImagePlugin",{init:function(t,n){t.settings.ck12_plugins_url&&(n=t.settings.ck12_plugins_url+"ck12image");var o=this;t.on("init",function(){!1!==t.settings.content_css&&t.dom.loadCSS(n+"/css/ck12image.css"),t&&(t.plugins.contextmenu||t.plugins.ck12contextmenu)&&(t.addMenuItem("ck12imageEditCM",{text:"Insert/Edit Image",context:"insert",cmd:"mceAdvImage",onPostRender:function(){this.visible(!0),o.contextMenu.changeText.call(this,t)},icon:"image",ui:!0}),t.addMenuItem("ck12imageDeleteCM",{text:"Delete Image",context:"insert",cmd:"mceDeleteImage",onPostRender:function(){o.contextMenu.postRender.call(this,t)},image:n+"/img/icon_img_del.gif",icon:"delete",ui:!0}))}),t.addCommand("mceAdvImage",function(){var i;e(t),i=t.selection.getNode();var a=t.dom.getAttrib(i,"class");(!a||-1===a.indexOf("mceItem")&&-1===a.indexOf("x-ck12-block-math")&&-1===a.indexOf("x-ck12-math")&&-1===a.indexOf("ck12-media-placeholder"))&&(t.windowManager.open({file:n+"/image.htm",classes:"window-tabs",title:"Insert/Edit Image",width:480+parseInt(t.getLang("advimage.delta_width",0)),height:window.innerHeight<645?360:575,inline:1},{plugin_url:n}),t.fire("focus:window"))}),t.addCommand("mceDeleteImage",function(){var n;e(t),n=t.selection.getNode();var i=t.dom.getParent(n,"div");i&&-1!==t.dom.getAttrib(i,"class").indexOf("x-ck12-img")?(i.parentNode.removeChild(i),t.execCommand("mceRepaint")):"IMG"===n.nodeName&&n.parentNode.removeChild(n),t.nodeChanged()}),t.addButton("image",{title:"Insert/Edit Image",cmd:"mceAdvImage"}),o.editor=t;var c=t.getParam("image_class_thumbnail"),s=t.getParam("image_class_postcard"),r=t.getParam("image_class_fullpage"),d=t.getParam("image_class_inline");t.on("nodechange",function(){var e,n,i,a,l=t.selection.getStart(),m=t.selection.getEnd();e=o._parentHasClass(l,[c,s,r]),n=o._parentHasClass(m,[c,s,r]),e||n?(o._setDisabled(!0),t.fire("enable",{button:"image"}),t.fire("active",{button:"image"})):(o._setDisabled(!1),i=o._parentHasClass(l,[d]),a=o._parentHasClass(m,[d]),i||a?(t.fire("disable",{buttons:o._fontButtons}),t.fire("active",{button:"image"})):(t.fire("enable",{buttons:o._fontButtons}),t.fire("inactive",{button:"image"})))}),t.on("KeyDown KeyPress KeyUp Paste",o._block),t.on("click",function(e){"IMG"===e.target.nodeName&&(tinyMCE.activeEditor.selection.select(e.target),e.preventDefault())}),i=function(e){var n=t.dom.getParent(e,"div");return!!("IMG"===e.nodeName&&-1===t.dom.getAttrib(e,"class").indexOf("math")&&-1===t.dom.getAttrib(e,"class").indexOf("ck12-media-placeholder")||n&&t.dom.getAttrib(n,"class").indexOf("x-ck12-img")>-1)},a=function(e){var n=t.dom.getParent(e,"span");return"IMG"===e.nodeName&&n&&"x-ck12-img-inline"===t.dom.getAttrib(n,"class")},t.events||(t.events={}),$.extend(!0,t.events,{ck12image:{isImage:i,isInlineImage:a}})},_parentHasClass:function(e,t){var n=this.editor.dom,i=function(e){for(var i=t.length-1;i>=0;i--)if(n.hasClass(e,t[i]))return!0;return!1};return n.getParent(e,function(e){var t=i(e);if(t)return t})},_block:function(e){if(n){var t=e.keyCode;if(8!==t&&46!==t){if(!(t>32&&t<41||t>111&&t<124))return o.cancel(e)}else tinymce.activeEditor.execCommand("mceDeleteImage")}},_fontButtons:["bold","italic","strikethrough","subscript","superscript","underline","ck12textcolor","ck12highlight","styleselect"],_uiButtons:function(){return Array.prototype.concat.apply(this._fontButtons,["blockquote","bullist","charmap","ck12definitionlist","ck12embed","ck12table","elementbox","fullscreen","hr","link","matheditor","numlist","redo","save","undo","unlink"])},_setDisabled:function(e){var t=this,i=t.editor,a=t._uiButtons();e?i.fire("disable",{buttons:a}):i.fire("enable",{buttons:a}),n=e,e!==t.disabled&&(t.disabled=e)},contextMenu:{postRender:function(n){function a(){var t,a,o;e(n),t=n.dom,a=n.selection.getNode()||n.getBody(),o=i(a,t),c.disabled(!o),c.visible(o),o&&n.fire("contextmenu:override",{enable:["ck12image"]})}function o(){n.on("contextmenu:reselect",function(e){t=e.range||null,a()})}var c=this;n.initialized?o():n.on("init",o)},changeText:function(e){function t(t){var n=i(t.target,e.dom)?"Edit Image":"Insert/Edit Image";a.$el.find("span").text(n)}function n(){e.on("contextmenu",t)}var a=this;e.initialized?n():e.on("init",n)}},getInfo:function(){return{longname:"Advanced image",author:"Moxiecode Systems AB",authorurl:"http://tinymce.moxiecode.com",infourl:"http://wiki.moxiecode.com/index.php/TinyMCE:Plugins/advimage",version:tinymce.majorVersion+"."+tinymce.minorVersion}}}),tinymce.PluginManager.add("ck12image",tinymce.plugins.CK12ImagePlugin)}();