function tinyMCEMathEditor(a,b){function c(a){function j(){q(),l(),k()}function k(){var a={};a.API=new d({callback:{get:function(){},set:m}}),window.mathEditorHelper.parentContainer=a}function l(){a.on("click",function(a){var b=$(a.target).closest("span.x-ck12-mathEditor"),c=$(tinymce.activeEditor.getBody()).find('span[data-mce-type="bookmark"]');tinyMCE.activeEditor.fire("inactive",{button:"matheditor"}),c.length>0&&c.remove(),0!==b.length&&setTimeout(function(){b.hasClass("doubleClick")?b.removeClass("doubleClick"):b.hasClass("forSingleClick")?b.removeClass("forSingleClick"):(tinyMCE.activeEditor.fire("active",{button:"matheditor"}),b.addClass("selectedElement"),tinyMCE.activeEditor.selection.select(b[0]))},1e3)}),a.on("dblclick",function(b){var g,h,i,j,k,l,m,c=void 0===b.target?b:b.target,d=c.hasAttribute("class")&&c.className.match("x-ck12-mathEditor")?$(c):$(c).closest("span.x-ck12-mathEditor");if(a.fire("inactive",{button:"matheditor"}),b.target&&d.addClass("doubleClick forSingleClick"),0!=d.length)tinymce.activeEditor.selection.collapse(),tinymce.activeEditor.selection.select(d[0]),g=decodeURIComponent(d[0].getAttribute("data-tex")),g.match("bmatrix")&&!g.match(" & ")?(h="",g=g.replace("&"," & ")):h=d[0].getAttribute("data-edithtml"),f=d[0].id,k=d[0].getAttribute("variable"),i=d[0].getAttribute("mathMethod"),i||(i=d[0].getAttribute("data-mathmethod")),j=d[0].getAttribute("data-math-class"),e={tex:g,edithtml:h,variable:k,isOldEditor:!1,mathType:i,mathClass:j},window.mathEditorHelper.editOptions=e,window.mathEditorHelper.editedElementId=f,window.mathEditorHelper.editMode=!0,o(e);else if($(c).hasClass("x-ck12-math")||$(c).hasClass("x-ck12-hwpmath")||$(c).hasClass("x-ck12-block-math")){g=$(c).attr("src").split("/");for(var n=0;n<g.length;n++)"alignat"!=g[n]&&"inline"!=g[n]&&"block"!=g[n]||(l=g.slice(n+1).join("/"),m=decodeURIComponent(l),i=g[n],j=$(c).attr("class"));e={tex:m,edithtml:"",variable:"",isOldEditor:!0,mathType:i,mathClass:j},window.mathEditorHelper.editOptions=e,window.mathEditorHelper.currentElement=c,window.mathEditorHelper.editMode=!0,tinymce.isIE&&a.selection.getBookmark(),o(e)}}),a.on("mousedown",function(b){var c=b.target,d=c.hasAttribute("class")&&c.className.match("x-ck12-mathEditor")?$(c):$(c).closest("span.x-ck12-mathEditor");a.fire("inactive",{button:"matheditor"}),$(a.dom.select("span.x-ck12-mathEditor")).removeClass("selectedElement showContextMenu forSingleClick doubleClick"),3===b.which&&0!==d.length&&d.addClass("showContextMenu")});var b={postRender:function(b,c){function e(){var h,e=b.dom,f=e.select("span.x-ck12-mathEditor.showContextMenu"),g=!1;c&&(h=a.selection.isCollapsed()),f.length>0&&(g="boolean"!==h||h,e.addClass(f[0],"selectedElement")),d.disabled(!g),d.visible(g),g&&a.fire("contextmenu:override",{enable:["matheditor"]})}function f(){b.on("contextmenu:postrender",e)}var d=this;b.initialized?f():b.on("init",f)}};a.on("init",function(){a&&(a.plugins.contextmenu||a.plugins.ck12contextmenu)&&(a.addMenuItem("mathEditorSelectCM",{text:"Select",context:"insert",cmd:"mathEditorSelect",onPostRender:function(){b.postRender.call(this,a)},ui:!0}),a.addMenuItem("mathEditorEditCM",{text:"Edit",context:"insert",cmd:"mathEditorEdit",onPostRender:function(){b.postRender.call(this,a)},ui:!0}),a.addMenuItem("mathEditorCopyCM",{text:"Copy equation",context:"insert",cmd:"Copy",onPostRender:function(){b.postRender.call(this,a,!0)},ui:!0}))}),a.addCommand("mathEditorSelect",function(){a.fire("active",{button:"matheditor"});var b=a.dom.select("span.x-ck12-mathEditor.selectedElement");"block"!==b[0].getAttribute("data-mathmethod")&&null!=b[0].previousSibling&&null!=b[0].previousSibling.nodeValue&&0===b[0].previousSibling.nodeValue.length&&$(b).before("&nbsp;"),null!==b[0].nextSibling&&null!==b[0].nextSibling.nodeValue&&0!==b[0].nextSibling.nodeValue.length||$(b).after("&nbsp;"),setTimeout(function(){a.selection.select(b[0]),a.focus()},500)}),a.addCommand("mathEditorEdit",function(){var b=a.dom.select("span.x-ck12-mathEditor.selectedElement");tinymce.activeEditor.dom.fire(b[0],"dblclick"),$(b).removeClass("selectedElement forSingleClick doubleClick")}),navigator.userAgent.toLowerCase().indexOf("firefox")!==-1&&a.on("keydown",function(b){var c=a.selection.getStart(),d=a.selection.getEnd(),e=[],f=null,g=null;if(g=a.dom.getPrev(a.selection.getStart(),function(b){return a.dom.hasClass(b,"x-ck12-mathEditor")}),e.push(c),e.push(d),8===b.keyCode){if("x-ck12-mathEditor"===c.className.split(/\s+/)[0])return void tinymce.activeEditor.dom.remove(c.id);if("x-ck12-mathEditor"===d.className.split(/\s+/)[0])return void tinymce.activeEditor.dom.remove(d.id);if(null!==g)return void tinymce.activeEditor.dom.remove(g.id);for(var i=0;i<e.length;i++){for(var j=e[i];j.parentNode;){if("x-ck12-mathEditor"===j.className.split(/\s+/)[0]){f=j.id;break}j=j.parentNode}if(null!==f){tinymce.activeEditor.dom.remove(c.id);break}}}})}function m(a){var c,d,e,g,b=tinyMCE.activeEditor,f=window.mathEditorHelper;if(a&&f.editMode&&f.editOptions){if(void 0!==f.editedElementId&&null!==f.editedElementId)tinymce.activeEditor.dom.get(f.editedElementId).innerHTML=a.wrapHtml.innerHTML,tinymce.activeEditor.dom.get(f.editedElementId).setAttribute("data-tex",encodeURIComponent(a.tex)),tinymce.activeEditor.dom.get(f.editedElementId).setAttribute("data-edithtml",a.editHtml),tinymce.activeEditor.dom.get(f.editedElementId).setAttribute("data-mathmethod",a.mathMethod),tinymce.activeEditor.dom.get(f.editedElementId).setAttribute("data-math-class",a.mathClass),tinymce.activeEditor.dom.get(f.editedElementId).removeAttribute("data-tex-mathjax"),tinymce.activeEditor.dom.get(f.editedElementId).removeAttribute("mathmethod"),n(f.editedElementId);else if(void 0!==f.currentElement&&null!==f.currentElement){for(c=tinymce.DOM.uniqueId();null!=tinymce.activeEditor.dom.get(c);)c=tinymce.DOM.uniqueId();g=c,d=tinyMCE.activeEditor.dom.create("span",{id:c,class:"x-ck12-mathEditor"},""),tinyMCE.activeEditor.dom.replace(d,f.currentElement,!0),tinymce.activeEditor.selection.collapse(!0),tinymce.activeEditor.dom.get(g).innerHTML=a.wrapHtml.innerHTML,tinymce.activeEditor.dom.get(g).setAttribute("data-tex",encodeURIComponent(a.tex)),tinymce.activeEditor.dom.get(g).setAttribute("data-edithtml",a.editHtml),tinymce.activeEditor.dom.get(g).setAttribute("contenteditable","false"),tinymce.activeEditor.dom.get(g).setAttribute("data-mathmethod",a.mathMethod),tinymce.activeEditor.dom.get(g).setAttribute("data-math-class",a.mathClass),n(g)}a=null,f.editOptions=null,f.editedElementId=null,f.currentElement=null,f.editMode=!1}if(a){for(b.focus(),c=tinymce.DOM.uniqueId();null!=tinymce.activeEditor.dom.get(c);)c=tinymce.DOM.uniqueId();g=c,d=tinyMCE.activeEditor.dom.create("span",{id:c,class:"x-ck12-mathEditor"},""),e=tinyMCE.activeEditor.dom.create("span",""),$(tinymce.activeEditor.getBody()).find('span[data-mce-type="bookmark"]').length>0?($(tinymce.activeEditor.getBody()).find('span[data-mce-type="bookmark"]').before(e),$(tinymce.activeEditor.getBody()).find('span[data-mce-type="bookmark"]').before(d)):tinyMCE.activeEditor.selection.setNode(d),tinymce.activeEditor.dom.get(g).innerHTML=a.wrapHtml.innerHTML,tinymce.activeEditor.dom.get(g).setAttribute("data-tex",encodeURIComponent(a.tex)),tinymce.activeEditor.dom.get(g).setAttribute("data-edithtml",a.editHtml),tinymce.activeEditor.dom.get(g).setAttribute("contenteditable","false"),tinymce.activeEditor.dom.get(g).setAttribute("data-mathmethod",a.mathMethod),tinymce.activeEditor.dom.get(g).setAttribute("data-math-class",a.mathClass),$(tinymce.activeEditor.dom.get(g)).after("&nbsp;"),n(g),a=null}$(tinymce.activeEditor.getBody()).find('span[data-mce-type="bookmark"]').remove(),tinyMCE.EditorManager.activeEditor.windowManager.close(),tinyMCE.activeEditor.execCommand("mceAutoResize")}function n(a){var b=[];b=$(tinyMCE.activeEditor.dom.get(a)).find("span[id^='MathJax']"),$.each(b,function(b,c){$(this).attr("id",a+"_"+$(this).attr("id"))})}function o(a){var a=void 0===a?{}:a,b=[];"undefined"!=typeof ae&&(b=ae.controllers.qb.getVariableData()),a.variable=b,p(function(a){window.mathEditorHelper.parentContainer.API.get(a)},a)}function p(b,d){var e=null,f=null,g=!1,h=40,i=1;$("#tinymceContentHelper").html(""),a.windowManager.open({file:c,title:"",width:900,height:""===d.edithtml||d.isOldEditor===!0||d.edithtml&&d.edithtml.indexOf("paste-option")!==-1||window.innerHeight<640?470:640,buttons:e,inline:1}),f=setInterval(function(){try{g&&b(d),!g&&i<=h?(g=window.mathEditorHelper.parentContainer.API.info().loaded,i++):(window.mathEditorHelper.parentContainer.API.resizeHandler(),clearInterval(f))}catch(a){}},1e3)}function q(){a.addButton("matheditor",{title:"Math Editor",image:b+"/img/icon_math_editor.gif",onclick:function(){tinymce.activeEditor=a,a.selection.collapse(),window.mathEditorHelper.editMode=!1;var b=tinyMCE.activeEditor.dom.select("span.x-ck12-mathEditor.selectedElement");0!=b.length?(tinymce.activeEditor.dom.fire(b[0],"dblclick"),$(b).removeClass("selectedElement")):($(tinymce.activeEditor.getBody()).find('span[data-mce-type="bookmark"]').remove(),a.selection.getBookmark(),e={tex:"newEquation",mathType:a.settings.default_math_type},o(e))}})}a.settings.ck12_plugins_url&&(b=a.settings.ck12_plugins_url+"matheditor");var c=b+"/shell/authoring/authoring.htm",e=null,f=null;window.mathEditorHelper={},j()}function d(a){function f(){return{events:b,loaded:d}}function g(a){e&&e.set&&"function"==typeof e.set&&e.set(a)}function h(a){var b=!1;return c&&c.API&&c.API.set&&"function"==typeof c.API.set&&(b=c.API.set(a)),b}function i(a){var b=a&&a.event?a.event:"";if(b)switch(b){case"onload":j(a);break;case"resize":}}function j(a){a&&a.API&&(c=c?c:{},c.API=a.API,d=!0)}function k(){d=!1}var b=["onload","resize"],c=null,d=!1,e=a&&a.callback?a.callback:null;this.info=f,this.get=h,this.set=g,this.notify=i,this.resizeHandler=k}new c(a)}tinymce.PluginManager.add("matheditor",tinyMCEMathEditor);