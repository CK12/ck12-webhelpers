!function(){"use strict";var a,b,c,d,e=(tinymce.dom.Event,"x-ck12-element-box-placeholder");tinymce.create("tinymce.plugins.ElementBoxPlugin",{init:function(f,g){f.settings.ck12_plugins_url&&(g=f.settings.ck12_plugins_url+"elementbox");var h=this;h.editor=f;tinymce.each;a=f.getParam("element_box_class"),b=f.getParam("element_box_header_class"),c=f.getParam("element_box_body_class"),f.addCommand("mceAddElementBox",function(){f.selection.collapse(0);var d='<div class="'+a+'">  <div class="'+b+'">&nbsp;<span id="_mce_temp_span">&nbsp;</span></div>  <div class="'+c+'"></div></div>';f.execCommand("mceInsertContent",!1,d,{skip_undo:1}),f.undoManager.add(),f.focus(),f.selection.select(f.dom.select("#_mce_temp_span")[0]),f.selection.collapse(0),f.dom.remove(f.dom.select("span#_mce_temp_span")[0])}),f.addCommand("mceDeleteElementBox",function(){var a=f.selection.getNode(),b=null;b=f.dom.hasClass(a,e)?a:f.dom.getParent(f.selection.getNode(),function(a){return f.dom.hasClass(a,e)}),b&&(b.parentNode.removeChild(b),f.execCommand("mceRepaint"))}),f.on("preinit",function(){f.parser.addNodeFilter("div",function(a){for(var b,c=a.length;c--;){b=a[c];var d=b.attr("class")||"";if("x-ck12-element-box"===d){var e=new tinymce.html.Node('table class="x-ck12-element-box-placeholder"'),f=new tinymce.html.Node('tr class="x-ck12-element-box-header"'),g=new tinymce.html.Node('tr class="x-ck12-element-box-body"'),h=new tinymce.html.Node('td class="x-ck12-editor-header-td-element-box"'),i=new tinymce.html.Node('td class="x-ck12-editor-body-td-element-box"'),j=b.getAll("div"),k=j[0],l=j[1];k&&(h.append(k),k.unwrap()),l&&(i.append(l),l.unwrap()),f.append(h),g.append(i),e.append(f),e.append(g),b.replace(e)}}})}),f.on("keydown",function(a){var e=a.keyCode,g=!1;if(13===d&&(g=!0),13===e?d=13:(d=e,g=!1),13===e){var i,j,k,l=f.dom.getParent(f.selection.getEnd(),function(a){return f.dom.hasClass(a,b)});if(l)return i=f.selection.getEnd().parentNode,j=l,k=j.nextSibling,k.className===c&&(f.focus(),f.selection.select(k.firstChild,!0),f.selection.collapse(!0)),tinymce.dom.Event.cancel(a);if(l=f.dom.getParent(f.selection.getEnd(),function(a){return f.dom.hasClass(a,c)}),l&&g)return h._overrideDoubleEnter(h,a)}}),f.on("preprocess",function(a){var b,c,d,e,f,g,i=this;for(b=i.dom.select(".x-ck12-element-box-placeholder"),c=b.length;c--;)d=b[c],e=$(d),f=e.find("td.x-ck12-editor-header-td-element-box"),g=e.find("td.x-ck12-editor-body-td-element-box"),e.replaceWith('<div class="x-ck12-element-box"><div class="x-ck12-element-box-header">'+f.html()+'</div><div class="x-ck12-element-box-body">'+g.html()+"</div></div>");a.get&&h._fixElementBoxes(i,h,a)}),f.addButton("elementbox",{title:"Insert Element Box",cmd:"mceAddElementBox",image:g+"/img/icon_elementbox.png"}),f.addMenuItem("elementboxCM",{text:"Delete Element Box",context:"insert",cmd:"mceDeleteElementBox",onPostRender:function(){h.contextMenu.postRender.call(this,f)},image:g+"/img/icon_elementbox_del.png",ui:!0}),f.events||(f.events={}),$.extend(!0,f.events,{elementbox:{toolbar:h.toolbar,contextMenu:h.contextMenu}})},getParentBlock:function(a){var b=this.editor.dom;return b.getParent(a,b.isBlock)},_fixElementBoxes:function(d,e,f){var g=tinymce.each;g(d.dom.select("DIV",f.node),function(f){if(null!==f.parentNode){if((d.dom.hasClass(f,b)||d.dom.hasClass(f,c))&&!d.dom.hasClass(f.parentNode,a)){var h=d.getDoc().createElement("P");h.innerHTML=f.innerHTML,d.dom.replace(h,f)}if(d.dom.hasClass(f,a)){var i=null;g(d.dom.select("DIV",f),function(b){if(d.dom.hasClass(b.parentNode,a)&&d.dom.hasClass(b,c))if(i){var f=d.getDoc().createElement("P");f.innerHTML=b.innerHTML,i.appendChild(f),b.parentNode.removeChild(b),d.execCommand("mceRepaint"),e.editor.nodeChanged()}else i=b})}if(d.dom.hasClass(f,a)){var j=!1,k=!1;if(g(f.children,function(e){d.dom.hasClass(e.parentNode,a)&&(d.dom.hasClass(e,b)?j=!0:d.dom.hasClass(e,c)&&(k=!0))}),!j){var l=d.getDoc().createElement("DIV");l.className=b,l.innerHTML="&nbsp;",f.insertBefore(l,f.firstChild)}if(!k){var m=d.getDoc().createElement("DIV");m.className=c,m.innerHTML="&nbsp;",f.appendChild(m)}}d.dom.hasClass(f,a)&&g(f.children,function(a){!a.innerHTML||0!==a.innerHTML.length&&"<br>"!==a.innerHTML&&"null"!==a.innerHTML||(a.innerHTML="&nbsp;")})}})},_overrideDoubleEnter:function(a,b){var c=a.editor;c.undoManager.beforeChange();var d=c.dom.getParent(c.selection.getEnd(),function(a){return c.dom.hasClass(a,e)}),f=d.nextSibling;if(!f&&d.parentNode){var g=c.getDoc().createElement("P");g.innerHTML="&nbsp;",d.parentNode.appendChild(g)}return f=d.nextSibling,f?(c.focus(),f.firstChild?c.selection.select(f.firstChild,!0):c.selection.select(f,!0),c.selection.collapse(1),tinymce.dom.Event.cancel(b)):void 0},getInfo:function(){return{longname:"CK-12 Element Box",author:"Shanmuga Bala",authorurl:"http://www.ck12.org",infourl:"https://insight.ck12.org/wiki/index.php/Tinymce-flxweb",version:"1.0"}},contextMenu:{postRender:function(a){function b(){var b=a.dom,c=a.selection,f=c.getNode()||a.getBody(),g=b.getParent(f,"table"),h=!(!g||!b.hasClass(g,e));d.disabled(!h),d.visible(h)}function c(){a.on("contextmenu:postrender",b)}var d=this;a.initialized?c():a.on("init",c)}},toolbar:{handleDisable:function(a,b){var c=b.dom,d=b.selection,e=this._parentsWithElementBoxClass(b,c,d),f=d.getNode()||b.getBody(),g=!(!e.sc&&!e.ec);b.events&&b.events.ck12image&&b.events.ck12image.isImage(f,c)&&(g=!0),a.disabled(g)},_parentsWithElementBoxClass:function(a,b,c){var d={},e=this;return d.sc=b.getParent(c.getStart(),function(a){return e._hasElementBoxClasses(b,a)}),d.ec=b.getParent(c.getEnd(),function(a){return e._hasElementBoxClasses(b,a)}),d},_hasElementBoxClasses:function(d,e){return d.hasClass(e,a)||d.hasClass(e,b)||d.hasClass(e,c)}}}),tinymce.PluginManager.add("elementbox",tinymce.plugins.ElementBoxPlugin)}();