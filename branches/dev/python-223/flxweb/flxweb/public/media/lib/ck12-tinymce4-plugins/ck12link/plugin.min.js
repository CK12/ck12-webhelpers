tinymce.PluginManager.add("ck12link",function(a){"use strict";function b(b){return function(){var c=a.settings.link_list;"string"==typeof c?tinymce.util.XHR.send({url:c,success:function(a){b(tinymce.util.JSON.parse(a))}}):"function"==typeof c?c(b):b(c)}}function c(a,b,c){function d(a,c){return c=c||[],tinymce.each(a,function(a){var e={text:a.text||a.title};a.menu?e.menu=d(a.menu):(e.value=a.value,b&&b(e)),c.push(e)}),c}return d(a,c||[])}function d(b){function d(a){var b=s.find("#text");(!b.value()||a.lastControl&&b.value()===a.lastControl.text())&&b.value(a.control.text()),s.find("#href").value(a.control.value())}function f(a){var b=[];return j(a,b),b.unshift({text:"None",value:""}),{name:"anchor",type:"listbox",label:"Anchors",values:b,onselect:d}}function h(){!r&&0===C.text.length&&t&&this.parent().parent().find("#text")[0].value(this.value())}function i(b){var c=b.meta||{};v&&v.value(a.convertURL(this.value(),"href")),tinymce.each(b.meta,function(a,b){s.find("#"+b).value(a)}),c.text||h.call(this)}function j(a,b){k(a,b),l(a,b),m(a,b)}function k(b,c){var d,e,f,h,i,j=0;for(h=a.dom.select("img"),e=0,i=h.length;i>e;e++)f=h[e],"SPAN"!==f.parentNode.nodeName&&-1===f.className.indexOf("ck12-media-placeholder")&&(d=a.dom.getAttrib(f,"id"),d&&-1!==d.indexOf("x-ck12-")?(d=d.replace("x-ck12-",""),c.push(n(d,"Figure",j++,b))):(d=(new Date).getTime().toString(),d="x-ck12-"+g.encode(d),a.dom.setAttrib(f,"id",d),d=d.replace("x-ck12-",""),c.push(n(d,"Figure",j++,b))))}function l(b,c){var d,e,f,h,i,j=0;for(i=a.dom.select("table"),e=0,f=i.length;f>e;e++)h=i[e],-1===a.dom.getAttrib(h,"class").indexOf("x-ck12-element-box-placeholder")&&(d=a.dom.getAttrib(h,"id"),d&&-1!==d.indexOf("x-ck12-")?(d=d.replace("x-ck12-",""),c.push(n(d,"Table",j++,b))):(d=(new Date).toString(),d="x-ck12-"+g.encode(d),a.dom.setAttrib(h,"id",d),d=d.replace("x-ck12-",""),c.push(n(d,"Table",j++,b))))}function m(b,c){var d,e,f,h,i,j=0;for(i=a.dom.select(".ck12-media-placeholder"),e=0,f=i.length;f>e;e++)h=i[e],d=a.dom.getAttrib(h,"data-ck12embed-iframe-id"),d&&-1!==d.indexOf("x-ck12-")?(d=d.replace("x-ck12-",""),c.push(n(d,"Object",j++,b))):(d=(new Date).toString(),d="x-ck12-"+g.encode(d),a.dom.setAttrib(h,"data-ck12embed-iframe-id",d),d=d.replace("x-ck12-",""),c.push(n(d,"Object",j++,b)))}function n(a,b,c,d){return{text:b+" "+(c+1)+" ("+a+")",value:"#"+a,selected:-1!==d.indexOf("#"+a)}}function o(a){var b=D.getContent();if(/</.test(b)&&(!/^<a [^>]+>[^<]+<\/a>$/.test(b)||-1===b.indexOf("href=")))return!1;if(a){var c,d=a.childNodes;if(0===d.length)return!1;for(c=d.length-1;c>=0;c--)if(3!==d[c].nodeType)return!1}return!0}var p,q,r,s,t,u,v,w,x,y,z,A,B,C={},D=a.selection,E=a.dom;e(),p=D.getNode(),q=E.getParent(p,"a[href]"),t=o(),C.text=r=q?q.innerText||q.textContent:D.getContent({format:"text"}),C.href=q?E.getAttrib(q,"href"):"",q?C.target=E.getAttrib(q,"target"):a.settings.default_link_target&&(C.target=a.settings.default_link_target),(B=E.getAttrib(q,"rel"))&&(C.rel=B),(B=E.getAttrib(q,"class"))&&(C["class"]=B),(B=E.getAttrib(q,"title"))&&(C.title=B),t&&(u={name:"text",type:"textbox",size:40,label:"Text to display",onchange:function(){C.text=this.value()}}),b&&(v={type:"listbox",label:"Link list",values:c(b,function(b){b.value=a.convertURL(b.value||b.url,"href")},[{text:"None",value:""}]),onselect:d,value:a.convertURL(C.href,"href"),onPostRender:function(){v=this}}),a.settings.target_list!==!1&&(a.settings.target_list||(a.settings.target_list=[{text:"None",value:""},{text:"New window",value:"_blank"}]),x={name:"target",type:"listbox",label:"Target",values:c(a.settings.target_list)}),a.settings.rel_list&&(w={name:"rel",type:"listbox",label:"Rel",values:c(a.settings.rel_list)}),a.settings.link_class_list&&(y={name:"class",type:"listbox",label:"Class",values:c(a.settings.link_class_list,function(b){b.value&&(b.textStyle=function(){return a.formatter.getCssText({inline:"a",classes:[b.value]})})})}),a.settings.link_title!==!1&&(z={name:"title",type:"textbox",label:"Title",value:C.title}),a.settings.anchor!==!1&&a.settings.rel_list&&(A={name:"anchor",type:"listbox",label:"Anchor",values:c(a.settings.rel_list)}),s=a.windowManager.open({title:"Insert link",data:C,body:[{name:"href",type:"filepicker",filetype:"file",size:40,autofocus:!0,label:"Url",onchange:i,onkeyup:h},u,z,A,f(C.href),v,w,x,y],onSubmit:function(b){function c(b,c){var d=a.selection.getRng();window.setTimeout(function(){a.windowManager.confirm(b,function(b){a.selection.setRng(d),c(b)})},0)}function d(){var b={href:e,target:C.target?C.target:null,rel:C.rel?C.rel:null,"class":C["class"]?C["class"]:null,title:C.title?C.title:null};q?(a.focus(),t&&C.text!=r&&("innerText"in q?q.innerText=C.text:q.textContent=C.text),E.setAttribs(q,b),D.select(q),a.undoManager.add()):t?a.insertContent(E.createHTML("a",b,E.encode(C.text))):a.execCommand("mceInsertLink",!1,b)}var e;return C=tinymce.extend(C,b.data),(e=C.href)?e.indexOf("@")>0&&-1===e.indexOf("//")&&-1===e.indexOf("mailto:")?void c("The URL you entered seems to be an email address. Do you want to add the required mailto: prefix?",function(a){a&&(e="mailto:"+e),d()}):a.settings.link_assume_external_targets&&!/^\w+:/i.test(e)||!a.settings.link_assume_external_targets&&/^\s*www\./i.test(e)?void c("The URL you entered seems to be an external link. Do you want to add the required http:// prefix?",function(a){a&&(e="http://"+e),d()}):void d():void a.execCommand("unlink")}}),a.fire("focus:window")}function e(){var b=a.selection.getRng();f&&b!==f?(a.selection.setRng(f),f=null):b===f&&(f=null)}var f,g={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_.",encode:function(a){var b,c,d,e,f,h,i,j="",k=0;for(a=g._utf8_encode(a);k<a.length;)b=a.charCodeAt(k++),c=a.charCodeAt(k++),d=a.charCodeAt(k++),e=b>>2,f=(3&b)<<4|c>>4,h=(15&c)<<2|d>>6,i=63&d,isNaN(c)?h=i=64:isNaN(d)&&(i=64),j=j+this._keyStr.charAt(e)+this._keyStr.charAt(f)+this._keyStr.charAt(h)+this._keyStr.charAt(i);return j},_utf8_encode:function(a){a=a.replace(/\r\n/g,"\n");for(var b="",c=0;c<a.length;c++){var d=a.charCodeAt(c);128>d?b+=String.fromCharCode(d):d>127&&2048>d?(b+=String.fromCharCode(d>>6|192),b+=String.fromCharCode(63&d|128)):(b+=String.fromCharCode(d>>12|224),b+=String.fromCharCode(d>>6&63|128),b+=String.fromCharCode(63&d|128))}return b}},h={postRender:function(a){function b(){e();var b=a.selection,c=b.getNode()||a.getBody(),f="string"==typeof c.innerText&&c.innerText.trim().length>0;d.disabled(!f),d.visible(f)}function c(){a.on("contextmenu:reselect",function(a){f=a.range||null}),a.on("contextmenu:postrender",b)}var d=this;a.initialized?c():a.on("init",c)}},i={postRender:function(a){function b(){var b=a.dom,c=a.selection,e=c.getNode()||a.getBody(),f=!1;a.events&&a.events.ck12image&&a.events.ck12image.isImage(e,b)&&(f=!0),d.disabled(f)}function c(){a.on("nodechange",b)}var d=this;a.initialized?c():a.on("init",c)}};a.addButton("link",{icon:"link",tooltip:"Insert/Edit link",shortcut:"Meta+K",onclick:b(d),stateSelector:"a[href]",onPostRender:function(){i.postRender.call(this,a)}}),a.addButton("unlink",{icon:"unlink",tooltip:"Remove link",cmd:"unlink",stateSelector:"a[href]",onPostRender:function(){i.postRender.call(this,a)}}),a.addShortcut("Meta+K","",b(d)),a.addCommand("mceLink",b(d)),this.showDialog=d,a.addMenuItem("link",{icon:"link",text:"Insert/Edit link",shortcut:"Meta+K",onclick:b(d),onPostRender:function(){h.postRender.call(this,a)},context:"insert",prependToContext:!0}),a.addMenuItem("unlink",{icon:"unlink",text:"Unlink",cmd:"unlink",stateSelector:"a[href]",context:"insert",prependToContext:!0})});