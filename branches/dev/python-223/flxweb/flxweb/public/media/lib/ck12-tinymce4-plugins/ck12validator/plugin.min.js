!function(){"use strict";var e="x-ck12-dirty",t="x-ck12-validationerror",n="x-ck12-validated",i=["__mce_tmp","ck12image","__mce_tmp_caption","previewImg","mce_marker","mcepastebin","_mce_caret"],a=["ck12-media-placeholder","mceItemTable","mce-item-table","x-ck12-mce-item-selected"],r=["data-error","data-mce-src","data-mce-bogus"],o=["mce_bogus"],s=[],d=[],c=["ul","ol"],l=["nobr"];tinymce.create("tinymce.plugins.CK12ValidatorPlugin",{init:function(e){this.initializePlugin(e)},initializePlugin:function(m){function h(){if(!m.id||-1!==m.id.indexOf("chapter"))return!1;var e=m.dom.select("."+t);$("#validating-progress").addClass("hide"),e instanceof Array&&e.length?$(e).eq(0).data("error")?($("#validating-check").addClass("hide"),$(".js_save_artifact").addClass("disabled js-disabled"),$("#data-image-alert-container").removeClass("hide").data("target",$(e).eq(0)).data("errors",e).data("current",0)):($(e).eq(0).removeClass(t),h()):$("#data-image-alert-container").addClass("hide")}function f(e){var t,n,i=[],a=e.attributes;if(a.length){for(t=0;t<a.length;t++)n=a[t].name,$(e).attr(n,(a[t].value||"").trim()),0===n.indexOf("data-")&&-1===r.indexOf(n)&&-1===n.indexOf("data-ck12embed-")&&i.push(a[t].name),n&&!a[t].value&&i.push(a[t].name),-1!==o.indexOf(n)&&i.push(a[t].name);$(e).removeAttr(i.join(" "))}}function u(e,t){var n,i=[],a="string"==typeof t||t instanceof String;if(a&&(t=t.split(" ")),t.length){for(n in t)t.hasOwnProperty(n)&&(t[n].name?i.push(t[n].name):a&&i.push(t[n]));e.removeAttr(i.join(" "))}}function g(e,t){var n,i=[];if(t.length){for(n in t)t.hasOwnProperty(n)&&t[n].name&&t[n].name.match(/data-.*/g)&&i.push(t[n].name);e.removeAttr(i.join(" "))}}function v(){"img"===this.nodeName.toLowerCase()&&-1!==this.src.indexOf("data:image")&&($(document).trigger($.flxweb.editor.tinymce.events.DATA_IMAGE,this),$(this).addClass("x-ck12-dataimage-"+window.imageClassIterator))}function p(e){var t=$(e);return!!t.attr("src")&&(0!==t.attr("src").indexOf("/flx/show")&&(0!==t.attr("src").indexOf("/flx/math")&&(0!==t.attr("src").indexOf("/flx/render")&&(0!==t.attr("src").indexOf("/media")&&(0!==t.attr("src").indexOf("//")&&t.attr("src")!==t.prop("src"))))))}function x(e){var t=m.dom;return t.getParent(e,t.isBlock)}function C(){if($(this).hasClass("x-ck12-mathEditor")||$(this).parents(".x-ck12-mathEditor").length)return this;if(-1!==l.indexOf((this.tagName||"").toLowerCase()))return $(this).remove(),!1;if("img"===this.tagName.toLowerCase()){if(p(this))return-1===d.indexOf($(this).attr("src"))&&d.push($(this).attr("src")),$(this).parent().hasClass("x-ck12-img-inline")?$(this).parent().remove():$(x(this,m)).remove(),!1;"__mce_tmp"!==this.id&&""===this.src&&this.remove()}var e,t=this.classList;for((0!==this.id.indexOf("x-ck12-")||8>this.id.length)&&-1===i.indexOf(this.id)&&(this.id=""),e=0;e<t.length;e++)(0!==t.item(e).indexOf("x-ck12-")||8>t.item(e).length)&&-1===a.indexOf(t.item(e))&&(t.remove(t.item(e)),e--);return f(this),this}function b(){this.id&&(-1!==s.indexOf(this.id)?this.id="":s.push(this.id)),C.call(this),v.call(this)}function k(e,n){if(0===e.length)for(var i=n.firstChild;i;)m.dom.hasClass(i,t)&&e.push(i),i=i.nextSibling;return e}function O(){var e=$(this);"NOBR"!==e.prop("tagName")?(e.removeAttr("role aria-readonly contenteditable tabindex").removeClass("MathJax MathJax_Display selectedElement showContextMenu ck12-media-placeholder doubleClick forSingleClick"),g(e,this.attributes)):e.remove()}function y(e){return btoa(encodeURIComponent(e).replace(/%([0-9A-F]{2})/g,function(e,t){return String.fromCharCode("0x"+t)}))}function w(){if(!m.dom.doc)return!1;var i,a,r,o,s,d,c=$("<div>"+m.getContent()+"</div>");if(c.find("#MathJax_Hidden").length>0&&1===c.find("#MathJax_Hidden").parent().children().length&&c.find("#MathJax_Hidden").parent().remove(),$('div[id^="MathJax"]',c).remove(),""!==$(c).html().trim()){try{i=m.windowManager.windows.length&&tinymce.isIE?null:m.selection.getBookmark()}catch(e){i=null}i&&m.selection.moveToBookmark(i),r=m.dom.select('.x-ck12-dirty:not(".x-ck12-validated")'),s=[];for(o in r)r.hasOwnProperty(o)&&(a=document.createElement("div"),$(r[o]).removeAttr("data-error"),a.appendChild(r[o].cloneNode(!0)),$(a).find("*").each(O),s[o]=a.innerHTML);s&&s.length>0&&(d=JSON.stringify(s),$(".js_save_artifact").removeClass("disabled js-disabled"),$.ajax({type:"POST",dataType:"json",contentType:"text/plain",url:"/flx/validate/validateXhtmlList",data:y(d),success:function(i){if(i.response.hasOwnProperty("result")&&"Validated"===i.response.result){var a,o;for(a in r)r.hasOwnProperty(a)&&($(r[a]).removeClass(e).addClass(n),"valid"===(o=i.response.validations[a]instanceof Array?i.response.validations[a][0]:i.response.validations[a])?$(r[a]).removeClass(t).removeAttr("data-error"):$(r[a]).addClass(t).attr("data-error",o))}else console.log("There is an error in the entered HTML."),console.log(s),console.log(i.response.message||""),$(r).eq(0).addClass(t).attr("data-error",i.response.message||"");I=$(m.getBody()).html(),h()},error:function(){}})),$.each(m.dom.select(".x-ck12-mathEditor[id]"),function(){$(this).attr("contenteditable",!1)})}setTimeout(w,1e4)}function M(e){return 8===e||9===e||13===e||32===e||46===e||(e>=48&&e<=57||(e>=65&&e<=90||(e>=96&&e<=111||(e>=186&&e<=192||e>=219&&e<=222))))}function P(e){return e>=37&&e<=40}function _(e){return!!e&&["keydown","keyup"].indexOf(e.type)>-1}function A(){$.flxweb.editor.current_artifact.trigger("change")}function R(e){M(j=e===j?j:e.keyCode||e.which)&&A()}function N(t,i){var a=x(t,m);a&&(i&&I!==i&&m.dom.removeClass(a,n),m.dom.hasClass(a,n)||(m.dom.addClass(a,e),C.call(a),$(a).find("*").each(C)))}function E(e){return!!(e&&$(e)instanceof $&&$(e).length)&&-1!==c.indexOf(($(e)[0].tagName||"").toLowerCase())}function T(t,i){if(t.length&&t.text().trim()){var a=$(i).parents();if(!a.filter("."+e).length&&!a.filter("."+n).length)return!0}return!1}var I,L=this;L.editor=m;var j;L.checkForChild=k,m.on("nodechange",function(){m.dom.select("."+t).length||($("#data-image-alert-container").addClass("hide"),$(".js_save_artifact").removeClass("disabled js-disabled"))}),m.on("change",function(e){var t=e.level;if(t&&!t.hasOwnProperty("beforeBookmark")){var n=$.flxweb.editor.removeValidatorattributes(t.content);I===n||m.selectEditorTab||(N(m.selection.getNode(),n),I=n,_(e.originalEvent)||P(j)?R(e.originalEvent||j):A())}}),m.on("keyup",R),m.on("BeforeSetContent",function(i){if((i.content||"").trim()){var a,r,o,c=m.dom.create("div");if((o=$(c).append(i.content)).contents().each(function(){var i,a=$(this);m.dom.isBlock(this)&&"OL"!==this.nodeName?a.addClass(e):1===this.nodeType?a.removeClass(e+" "+t+" "+n):3===this.nodeType&&this.nodeValue.trim()&&(i=a.wrap("<span></span>")),i||(i=$(this.childNodes).filter(function(){return 3===this.nodeType})),T(i,this)&&N(this,!1)}),s=[],d=[],o.find("*").each(b),d.length){for(r="",a=0;a<d.length;a++)r+="<span>"+(a+1)+". "+d[a]+"</span></br>";$.flxweb.editor.showSaveDialog({width:670,className:"sent-email-modal",headerText:"The following images you have added are not supported by our editor. In case of any queries, please contact customer support.",contentText:r,buttons:[{text:"OK",className:"turquoise",onclick:$.flxweb.editor.hideSaveDialog}]}),r="",d=[]}I=o.html(),i.content=I}}),m.on("BeforeAddUndo",function(e){e.level&&e.level.content===I&&e.preventDefault()}),m.on("init",function(){m&&(m.plugins.contextmenu||m.plugins.ck12contextmenu)&&(m.addMenuItem("validatorErrorInfoCM",{text:"View Error Info",context:"insert",cmd:"mceErrorIfno",icon:"newdocument",onPostRender:function(){L.contextMenu.postRender.call(this,m,L)},ui:!0}),m.addMenuItem("validatorRemoveFormattingCM",{text:"Remove Formatting",context:"insert",cmd:"mceRemoveFormatting",icon:"cancel",onPostRender:function(){L.contextMenu.postRender.call(this,m,L)},ui:!0}),m.addMenuItem("validatorRemoveElementCM",{text:"Remove Element",context:"insert",cmd:"mceRemoveElement",icon:"cancel",onPostRender:function(){L.contextMenu.postRender.call(this,m,L)},ui:!0}),m.addMenuItem("validatorRevalidateCM",{text:"Revalidate",context:"insert",cmd:"mceRevalidate",icon:"revalidate",onPostRender:function(){L.contextMenu.postRender.call(this,m,L)},ui:!0})),m.setContent(m.getContent({cleanup:!0}),{cleanup:!0}),w()}),m.addCommand("mceRemoveElement",function(){var e,n=m.selection.getNode();(e=k(e=m.dom.getParents(n,".x-ck12-validationerror"),n))[0]&&-1!==m.dom.getAttrib(e[0],"class").indexOf(t)?e[0].parentNode.removeChild(e[0]):n&&-1!==m.dom.getAttrib(n,"class").indexOf(t)?n.parentNode.removeChild(n):(e=m.dom.getParent(n,"p"),-1!==m.dom.getAttrib(e,"class").indexOf(t)&&e.parentNode.removeChild(e))}),m.addCommand("mceRemoveFormatting",function(){var t=m.selection.getNode();t=m.dom.getParents(t,".x-ck12-validationerror"),u($(t[0]),t[0].attributes),m.dom.addClass(t[0],e),(t=E((t=$(t[0]))[0])?$(t[0]).children():$(t[0])).each(function(){this.innerHTML=$(this).text()})}),m.addCommand("mceRevalidate",function(){var t=m.selection.getNode();t=m.dom.getParents(t,".x-ck12-validationerror"),C.call(t[0]),t[0].classList.add(e),t[0].classList.remove(n)}),m.addCommand("mceErrorIfno",function(){var e,n=m.selection.getNode(),i="";e=k(e=m.dom.getParents(n,".x-ck12-validationerror"),n),-1!==m.dom.getAttrib(n,"class").indexOf(t)||-1!==m.dom.getAttrib(e[0],"class").indexOf(t)?i=$(n).attr("data-error")||$(e[0]).attr("data-error"):(e=m.dom.getParent(n,"p"),-1!==m.dom.getAttrib(e,"class").indexOf(t)&&(i=$(e).attr("data-error"))),tinyMCE.activeEditor.windowManager.alert(i,function(){})})},contextMenu:{postRender:function(e,n){function i(i){var a,o=e.dom,s=e.selection.getNode()||e.getBody(),d=e.dom.getParents(s,".x-ck12-validationerror");(d=n.checkForChild(d,s))[0]&&-1===o.getAttrib(d[0],"class").indexOf(t)&&(d=o.getParent(i,"p")),a=!!(d[0]&&-1!==o.getAttrib(d[0],"class").indexOf(t)||"BODY"!==s.nodeName&&o.getAttrib(s,"class")&&-1!==o.getAttrib(i,"class").indexOf(t)),r.disabled(!a),r.visible(a)}function a(t){e.on("contextmenu:postrender",function(){i(t)})}var r=this;e.initialized?a():e.on("init",a)}},getInfo:function(){return{longname:"CK-12 Validator ",author:"Chetan Padhye",authorurl:"http://www.ck12.org",infourl:"https://insight.ck12.org/wiki/index.php/Tinymce-flxweb",version:"1.0"}}}),tinymce.PluginManager.add("ck12validator",tinymce.plugins.CK12ValidatorPlugin)}();