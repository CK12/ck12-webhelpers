#! /bin/bash
# -----------------------------------------------------------------------------------
# CHANGE SET [17324]
#   RC3 Learning Analytics changes
# -----------------------------------------------------------------------------------

source funcs.sh

echo 'Apply change set 17324 (FlexBook-specific changes)'

register_dims() {
	echo '... Register new dimensions'
	
	mysql -h ${db_host} -u ${db_user} -p${db_password} ${db} <<EOF
delete from Dimensions where name in ('books', 'fbs_groups');
EOF
	
    # books
    http 'meta/register/dimension' 'name=books&tag=1'  # tag == subject
    http 'meta/add/hierarchy' 'name=h1&dimension_name=books'
    http 'meta/add/level' 'name=concept&hierarchy_name=h1&dimension_name=books'  # concepts or sections
    http 'meta/add/level' 'name=book&hierarchy_name=h1&dimension_name=books'
    http 'meta/add/level' 'name=branch&hierarchy_name=h1&dimension_name=books'
    set_loadscript books books.load
    http 'meta/load/dimension' 'dimension_name=books'
    
    # groups
    http 'meta/register/dimension' 'name=fbs_groups'
    http 'meta/add/hierarchy' 'name=h1&dimension_name=fbs_groups'
    http 'meta/add/level' 'name=group&hierarchy_name=h1&dimension_name=fbs_groups'
    set_loadscript 'fbs_groups' 'fbs_groups.load'
    http 'meta/load/dimension' 'dimension_name=fbs_groups'
}

create_triggers() {
    set_updatescript 'books' 'books.trigger'
    set_updatescript 'fbs_groups' 'fbs_groups.trigger'
}    

register_events() {    
	echo '... Register new events'
	
	mysql -h ${db_host} -u ${db_user} -p${db_password} ${db} <<EOF
delete from Measures where name in ('exercise', 'fbs_note', 'fbs_highlight', 'fbs_time_spent');
EOF

    # Event Group: exercises
    #  Attributes: question_type, question_id, difficulty_level, confidence_level, resources_used
    #      Events: correct, wrong, skipped, hint, time_spent
    #
    http 'meta/register/eventgroup' 'name=exercise&dimensions=artifacts,users&attributes=question_type,question_id,difficulty_level,confidence_level,resources_used&latency=1'
    http 'meta/register/event' 'name=correct&event_group=exercise'
    http 'meta/register/event' 'name=wrong&event_group=exercise'
    http 'meta/register/event' 'name=skipped&event_group=exercise'
    http 'meta/register/event' 'name=hint&event_group=exercise'
    http 'meta/register/event' 'name=time_spent&event_group=exercise'    

    # Promote `ts` to be an event
    http 'meta/register/event' 'name=ts&event_group=exercise'
    
    # artifact's Scrible notes
    http 'meta/register/eventgroup' 'name=fbs_note&dimensions=artifacts,revisions,users&latency=1'
    http 'meta/register/event' 'name=count&event_group=fbs_note'

    # artifact's Scrible highlight
    http 'meta/register/eventgroup' 'name=fbs_highlight&dimensions=artifacts,revisions,users&latency=1'
    http 'meta/register/event' 'name=count&event_group=fbs_highlight'
    
    # time spent on artifacts
    http 'meta/register/eventgroup' 'name=fbs_time_spent&dimensions=artifacts,revisions,users&latency=1'
    http 'meta/register/event' 'name=duration&event_group=fbs_time_spent'
}

register_metrics() {
	echo '... Register new metrics'
	
	mysql -h ${db_host} -u ${db_user} -p${db_password} ${db} <<EOF
delete from Measures where name in ('duration', 'correct_count', 'total_attempt');
delete from Measures where name like 'm\_%';
EOF

    # App does not have group ID to send along the events, register wrapper metrics for
    # events that need to be dissected by groups.
    #
    http 'meta/register/metric' "name=m_correct&dimensions=artifacts,users,fbs_groups:userID|memberID@flx2.GroupHasMembers&source_column=correct&source_table=F_exercise&source_db_db=${db}&source_db_host=${db_host}&source_db_user=${db_user}&source_db_password=D-coD%2343"
    http 'meta/register/metric' "name=m_wrong&dimensions=artifacts,users,fbs_groups:userID|memberID@flx2.GroupHasMembers&source_column=wrong&source_table=F_exercise&source_db_db=${db}&source_db_host=${db_host}&source_db_user=${db_user}&source_db_password=D-coD%2343"
    http 'meta/register/metric' "name=m_skipped&dimensions=artifacts,users,fbs_groups:userID|memberID@flx2.GroupHasMembers&source_column=skipped&source_table=F_exercise&source_db_db=${db}&source_db_host=${db_host}&source_db_user=${db_user}&source_db_password=D-coD%2343"
    http 'meta/register/metric' "name=m_hint&dimensions=artifacts,users,fbs_groups:userID|memberID@flx2.GroupHasMembers&source_column=hint&source_table=F_exercise&source_db_db=${db}&source_db_host=${db_host}&source_db_user=${db_user}&source_db_password=D-coD%2343"
    http 'meta/register/metric' "name=m_time_spent&dimensions=artifacts,users,fbs_groups:userID|memberID@flx2.GroupHasMembers&source_column=time_spent&source_table=F_exercise&source_db_db=${db}&source_db_host=${db_host}&source_db_user=${db_user}&source_db_password=D-coD%2343"

    # Register wrapper metrics for events that need to be dissected by books.
    #
    http 'meta/register/metric' "name=m_b_correct&dimensions=artifacts,users,books:artifactID&source_column=correct&source_table=F_exercise&source_db_db=${db}&source_db_host=${db_host}&source_db_user=${db_user}&source_db_password=D-coD%2343"
    http 'meta/register/metric' "name=m_b_wrong&dimensions=artifacts,users,books:artifactID&source_column=wrong&source_table=F_exercise&source_db_db=${db}&source_db_host=${db_host}&source_db_user=${db_user}&source_db_password=D-coD%2343"
    http 'meta/register/metric' "name=m_b_skipped&dimensions=artifacts,users,books:artifactID&source_column=skipped&source_table=F_exercise&source_db_db=${db}&source_db_host=${db_host}&source_db_user=${db_user}&source_db_password=D-coD%2343"
    http 'meta/register/metric' "name=m_b_hint&dimensions=artifacts,users,books:artifactID&source_column=hint&source_table=F_exercise&source_db_db=${db}&source_db_host=${db_host}&source_db_user=${db_user}&source_db_password=D-coD%2343"
    http 'meta/register/metric' "name=m_b_time_spent&dimensions=artifacts,users,books:artifactID&source_column=time_spent&source_table=F_exercise&source_db_db=${db}&source_db_host=${db_host}&source_db_user=${db_user}&source_db_password=D-coD%2343"
    http 'meta/register/metric' "name=m_b_duration&dimensions=artifacts,users,books:artifactID&source_column=duration&source_table=F_fbs_time_spent&source_db_db=${db}&source_db_host=${db_host}&source_db_user=${db_user}&source_db_password=D-coD%2343"    
}

deploy_cdos() {
	workdir=${workdir:-$(dirname $0)}
	sudo mkdir -p /opt/data/ads/cdo
	sudo cp ${workdir}/cdo__concepts_in_book.py /opt/data/ads/cdo
}

patch_db() {
	echo '... Patch db'

	mysql -h ${db_host} -u ${db_user} -p${db_password} ${db} <<EOF
DROP VIEW IF EXISTS ArtifactsBrowseTerms;
CREATE SQL SECURITY DEFINER VIEW ArtifactsBrowseTerms
AS select a.id AS id,b.encodedID AS encodedID
from ((flx2.Artifacts a join flx2.BrowseTerms b) join flx2.ArtifactHasBrowseTerms c)
where ((a.id = c.artifactID) and (b.id = c.browseTermID));
EOF
}

register_dims
create_triggers
register_events
register_metrics
deploy_cdos
patch_db

echo 'Done'
