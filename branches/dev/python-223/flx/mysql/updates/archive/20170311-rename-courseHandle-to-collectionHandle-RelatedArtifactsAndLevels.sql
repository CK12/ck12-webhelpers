USE flx2;

ALTER ALGORITHM=UNDEFINED DEFINER=`dbadmin`@`localhost` SQL SECURITY DEFINER VIEW `RelatedArtifactsAndLevels` AS select `a`.`id` AS `id`,`a`.`artifactTypeID` AS `artifactTypeID`,`a`.`encodedID` AS `encodedID`,`a`.`name` AS `name`,`a`.`description` AS `description`,`a`.`handle` AS `handle`,`a`.`creatorID` AS `creatorID`,`a`.`ancestorID` AS `ancestorID`,`a`.`licenseID` AS `licenseID`,`a`.`creationTime` AS `creationTime`,`a`.`updateTime` AS `updateTime`,`ar`.`id` AS `artifactRevisionID`,`ar`.`publishTime` AS `publishTime`,`lvl`.`id` AS `levelID`,`lvl`.`name` AS `level`,`ra`.`domainID` AS `domainID`,`ra`.`collectionHandle` AS `collectionHandle`, `ra`.`sequence` AS `sequence`,`d`.`name` AS `domainTerm`,`d`.`handle` AS `domainHandle`,`d`.`encodedID` AS `domainEID`,`d`.`parentID` AS `parentID` from (((((`Artifacts` `a` left join `ArtifactsAndBrowseTerms` `lvl` on(((`a`.`id` = `lvl`.`id`) and (`lvl`.`termTypeID` = 7)))) join `ArtifactRevisions` `ar`) join `RelatedArtifacts` `ra`) join `BrowseTerms` `d`) join `ArtifactTypes` `at`) where ((`ra`.`artifactID` = `a`.`id`) and (`ra`.`domainID` = `d`.`id`) and (`d`.`termTypeID` in (4,10)) and (`ar`.`artifactID` = `a`.`id`) and (`ar`.`id` = (select max(`ArtifactRevisions`.`id`) from `ArtifactRevisions` where (`ArtifactRevisions`.`artifactID` = `a`.`id`))) and (`a`.`artifactTypeID` = `at`.`id`) and (`at`.`modality` = 1));

call update_dbpatch('20170311-rename-courseHandle-to-collectionHandle-RelatedArtifactsAndLevels.sql');

